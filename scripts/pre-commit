#!/usr/bin/env bash
# ============================================================================
# Pre-commit hook â€” Guardian credential scanner
# Blocks commits containing hardcoded secrets or sensitive files.
# Bypass with: git commit --no-verify
# ============================================================================

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'

FOUND=0

# Get staged files (only added/modified, not deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# â”€â”€â”€ Check for sensitive filenames â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SENSITIVE_NAMES=".env .env.local .env.production auth-profiles.json credentials.json secrets.yaml secrets.yml"

for file in $STAGED_FILES; do
    basename=$(basename "$file")
    for sensitive in $SENSITIVE_NAMES; do
        if [ "$basename" = "$sensitive" ]; then
            echo -e "${RED}ğŸš¨ BLOCKED: Sensitive file staged: $file${NC}"
            echo "   Add to .gitignore or use --no-verify to bypass"
            FOUND=1
        fi
    done
done

# â”€â”€â”€ Scan for secret patterns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SECRET_PATTERNS=(
    'sk-[a-zA-Z0-9]{20,}'
    'sk-ant-[a-zA-Z0-9\-]{20,}'
    'ghp_[a-zA-Z0-9]{36,}'
    'github_pat_[a-zA-Z0-9_]{20,}'
    'gho_[a-zA-Z0-9]{36,}'
    'glpat-[a-zA-Z0-9\-]{20,}'
    'xoxb-[a-zA-Z0-9\-]+'
    'xoxp-[a-zA-Z0-9\-]+'
    'AKIA[0-9A-Z]{16}'
)

SECRET_NAMES=(
    "OpenAI API key"
    "Anthropic API key"
    "GitHub personal access token"
    "GitHub fine-grained PAT"
    "GitHub OAuth token"
    "GitLab personal access token"
    "Slack bot token"
    "Slack user token"
    "AWS access key"
)

for file in $STAGED_FILES; do
    # Skip binary files
    if file "$file" 2>/dev/null | grep -q "binary"; then
        continue
    fi

    # Skip files larger than 500KB
    size=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 500000 ]; then
        continue
    fi

    for i in "${!SECRET_PATTERNS[@]}"; do
        if grep -qE "${SECRET_PATTERNS[$i]}" "$file" 2>/dev/null; then
            echo -e "${RED}ğŸ”‘ BLOCKED: Possible ${SECRET_NAMES[$i]} found in: $file${NC}"
            FOUND=1
            break  # One warning per file
        fi
    done
done

# â”€â”€â”€ Check for generic secret assignments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for file in $STAGED_FILES; do
    if [ ! -f "$file" ]; then continue; fi
    size=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 500000 ]; then continue; fi

    if grep -qiE '(api_key|api-key|apikey|secret_key|secret-key|token|password|passwd)\s*[=:]\s*["\x27][a-zA-Z0-9\-_.]{20,}' "$file" 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  WARNING: Possible hardcoded secret in: $file${NC}"
        echo "   Review carefully. Use environment variables instead."
        # Warning only, don't block for generic patterns
    fi
done

if [ "$FOUND" -ne 0 ]; then
    echo ""
    echo -e "${RED}Commit blocked by Guardian pre-commit hook.${NC}"
    echo "Fix the issues above, or bypass with: git commit --no-verify"
    exit 1
fi

exit 0
